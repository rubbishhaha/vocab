<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Vocab Trainer</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			background-image: url('asset/red-and-blue-pillars-wallpaper-abstract-background-free-image.webp');
			background-size: cover;
			background-position: center;
			background-attachment: fixed;
			position: relative;
		}
		
		body::before {
			content: '';
			position: absolute;
			inset: 0;
			background: rgba(0, 0, 0, 0.4);
			z-index: 1;
		}
		
		.container {
			position: relative;
			z-index: 2;
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}
		
		header {
			display: flex;
			align-items: center;
			justify-content: space-between;
			margin-bottom: 30px;
			flex-wrap: wrap;
			gap: 20px;
		}
		
		h1 {
			font-size: 2.5rem;
			color: white;
			text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
		}
		
		.stats {
			display: flex;
			gap: 15px;
			flex-wrap: wrap;
		}
		
		.card {
			background: rgba(255, 255, 255, 0.15);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.2);
			padding: 15px 20px;
			border-radius: 15px;
			color: white;
			transition: all 0.3s;
		}
		
		.card:hover {
			background: rgba(255, 255, 255, 0.2);
			transform: translateY(-2px);
		}
		
		.section {
			background: rgba(255, 255, 255, 0.1);
			backdrop-filter: blur(10px);
			border: 1px solid rgba(255, 255, 255, 0.2);
			padding: 25px;
			border-radius: 20px;
			margin-bottom: 30px;
		}
		
		h2 {
			color: white;
			margin-bottom: 20px;
			font-size: 1.5rem;
			text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
		}
		
		label {
			display: block;
			color: white;
			margin-bottom: 8px;
			font-weight: 500;
		}
		
		input, textarea {
			width: 100%;
			padding: 12px;
			margin-bottom: 15px;
			border: 2px solid rgba(255, 255, 255, 0.3);
			border-radius: 10px;
			background: rgba(255, 255, 255, 0.9);
			font-size: 1rem;
			transition: all 0.3s;
		}
		
		input:focus, textarea:focus {
			outline: none;
			border-color: #667eea;
			box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
		}
		
		.button-group {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
		}
		
		button {
			padding: 12px 24px;
			border: none;
			border-radius: 10px;
			font-size: 1rem;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s;
		}
		
		button:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
		}
		
		.btn-primary {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}
		
		.btn-secondary {
			background: rgba(255, 255, 255, 0.2);
			color: white;
			border: 2px solid white;
		}
		
		.btn-success {
			background: #4CAF50;
			color: white;
		}
		
		.btn-danger {
			background: #f44336;
			color: white;
			padding: 8px 16px;
			font-size: 0.9rem;
		}
		
		.btn-edit {
			background: #2196F3;
			color: white;
			padding: 8px 16px;
			font-size: 0.9rem;
		}
		
		table {
			width: 100%;
			border-collapse: collapse;
			background: rgba(255, 255, 255, 0.95);
			border-radius: 10px;
			overflow: hidden;
		}
		
		th {
			background: rgba(102, 126, 234, 0.8);
			color: white;
			padding: 12px;
			text-align: left;
			font-weight: 600;
		}
		
		td {
			padding: 12px;
			border-bottom: 1px solid rgba(0, 0, 0, 0.1);
		}
		
		tr:hover {
			background: rgba(102, 126, 234, 0.1);
		}
		
		.quiz-redirect {
			background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
			color: white;
			padding: 30px;
			border-radius: 20px;
			text-align: center;
			margin-bottom: 30px;
			animation: pulse 2s infinite;
		}
		
		@keyframes pulse {
			0%, 100% { transform: scale(1); }
			50% { transform: scale(1.02); }
		}
		
		.quiz-link {
			display: inline-block;
			margin-top: 15px;
			padding: 15px 40px;
			background: white;
			color: #f5576c;
			text-decoration: none;
			border-radius: 10px;
			font-weight: 600;
			font-size: 1.1rem;
			transition: all 0.3s;
		}
		
		.quiz-link:hover {
			transform: scale(1.05);
			box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
		}
		
		.floating-elements {
			position: fixed;
			inset: 0;
			pointer-events: none;
			z-index: 1;
		}
		
		.floating-element {
			position: absolute;
			font-size: 2rem;
			opacity: 0.3;
			animation: float 6s infinite ease-in-out;
		}
		
		@keyframes float {
			0%, 100% { transform: translateY(0) rotate(0deg); }
			50% { transform: translateY(-30px) rotate(180deg); }
		}
		
		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			inset: 0;
			background: rgba(0, 0, 0, 0.7);
			backdrop-filter: blur(5px);
		}
		
		.modal.show {
			display: flex;
			align-items: center;
			justify-content: center;
			animation: fadeIn 0.3s;
		}
		
		@keyframes fadeIn {
			from { opacity: 0; }
			to { opacity: 1; }
		}
		
		.modal-content {
			background: white;
			padding: 30px;
			border-radius: 20px;
			max-width: 500px;
			width: 90%;
			animation: slideIn 0.3s;
		}
		
		@keyframes slideIn {
			from { transform: translateY(-50px); opacity: 0; }
			to { transform: translateY(0); opacity: 1; }
		}
		
		.modal h2 {
			color: #667eea;
			text-shadow: none;
			margin-bottom: 20px;
		}
		
		.modal label {
			color: #333;
		}
		
		.modal-buttons {
			display: flex;
			gap: 10px;
			margin-top: 20px;
		}
		
		.vocab-pool {
			position: relative;
			width: 100%;
			height: 400px;
			background: linear-gradient(180deg, rgba(100, 200, 255, 0.3) 0%, rgba(50, 150, 255, 0.5) 100%);
			border-radius: 20px;
			overflow: hidden;
			border: 3px solid rgba(255, 255, 255, 0.3);
			box-shadow: inset 0 0 30px rgba(0, 150, 255, 0.3);
		}
		
		.vocab-card {
			position: absolute;
			padding: 8px 12px;
			background: rgba(255, 255, 255, 0.9);
			border-radius: 8px;
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
			font-size: 0.9rem;
			font-weight: 600;
			color: #667eea;
			cursor: pointer;
			transition: transform 0.2s, box-shadow 0.2s;
			white-space: nowrap;
			max-width: 150px;
			overflow: hidden;
			text-overflow: ellipsis;
		}
		
		.vocab-card:hover {
			transform: scale(1.1);
			box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
			z-index: 100;
		}
		
		@keyframes wave {
			0%, 100% { transform: translateY(0px); }
			50% { transform: translateY(-5px); }
		}
	</style>
</head>
<body>
	<div class="floating-elements"></div>
	
	<div class="container">
		<header>
			<h1>üìö Vocab Trainer</h1>
			<div class="stats">
				<div class="card" style="cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="window.location.href='index.html'">
					üó∫Ô∏è Back to Mindmap
				</div>
			</div>
		</header>

		<section id="quizRedirect" class="quiz-redirect" style="display: none;">
			<h2>üéØ You have vocabulary to review!</h2>
			<p>Complete your daily review before adding new vocabulary</p>
			<a href="quiz.html" class="quiz-link">Start Quiz ‚Üí</a>
		</section>

		<section class="section">
			<h2>üìù Add New Vocabulary</h2>
			<label>Word</label>
			<input id="inputWord" type="text" placeholder="e.g. abate" />
			<label>Definition</label>
			<textarea id="inputDef" rows="3" placeholder="Enter the definition here..."></textarea>
			<div class="button-group">
				<button id="addBtn" class="btn-primary">‚ú® Add Vocabulary</button>
				<button id="clearBtn" class="btn-secondary">üóëÔ∏è Clear</button>
			</div>
		</section>

		<section class="section">
			<h2>üìÖ Today's Added Vocabulary</h2>
			<table id="todayList">
				<thead>
					<tr>
						<th>Word</th>
						<th>Definition</th>
						<th>Status</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</section>

		<section class="section">
			<h2>üìö All Vocabulary</h2>
			<div style="margin-bottom: 20px;">
				<input id="searchInput" type="text" placeholder="üîç Search by word or definition..." style="width: 100%; max-width: 500px;" />
			</div>
			<table id="allList">
				<thead>
					<tr>
						<th>Word</th>
						<th>Definition</th>
						<th>Date Added</th>
						<th>Reviews</th>
						<th>Actions</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</section>

		<section class="section" style="margin-top: 50px;">
			<h2 style="text-align: center; font-size: 1.8rem; margin-bottom: 10px;">üåä Vocab Pool</h2>
			<p id="poolMessage" style="text-align: center; color: white; font-size: 1.2rem; margin-bottom: 20px;">You have stored 0 vocabs! Keep going! üéâ</p>
			<div id="vocabPool" class="vocab-pool"></div>
		</section>
	</div>

	<!-- Edit Modal -->
	<div id="editModal" class="modal">
		<div class="modal-content">
			<h2>‚úèÔ∏è Edit Vocabulary</h2>
			<label>Word</label>
			<input id="editWord" type="text" />
			<label>Definition</label>
			<textarea id="editDef" rows="3"></textarea>
			<div class="modal-buttons">
				<button id="saveEditBtn" class="btn-primary">üíæ Save</button>
				<button id="cancelEditBtn" class="btn-secondary">‚ùå Cancel</button>
			</div>
		</div>
	</div>

	<script>
		let state = null;
		let editingId = null;
		let searchQuery = '';

		// Helper functions
		function todayStr(d = new Date()) {
			return d.toISOString().slice(0, 10);
		}

		function daysBetween(aStr, bStr) {
			const a = new Date(aStr + 'T00:00:00');
			const b = new Date(bStr + 'T00:00:00');
			return Math.floor((b - a) / (1000 * 60 * 60 * 24));
		}

		function addDays(dateStr, days) {
			const d = new Date(dateStr + 'T00:00:00');
			d.setDate(d.getDate() + days);
			return d.toISOString().slice(0, 10);
		}

		function escapeHtml(s) {
			return (s || '').replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;');
		}

		// API functions
		async function apiGetState() {
			const res = await fetch('/api/state');
			if (!res.ok) throw new Error('Failed to load state');
			return res.json();
		}

		async function apiPutState(state) {
			await fetch('/api/state', {
				method: 'PUT',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(state)
			});
		}

		// Get items that need quiz
		function getDueItems() {
			const dueDays = [1, 2, 5, 8];
			const today = todayStr();
			return state.items.filter(item => {
				const daysSinceAdded = daysBetween(item.dateAdded, today);
				for (const dueDay of dueDays) {
					const scheduledDate = addDays(item.dateAdded, dueDay);
					if (!item.reviews.includes(scheduledDate) && daysSinceAdded >= dueDay) {
						return true;
					}
				}
				return false;
			});
		}

		// Check if should redirect to quiz
		function checkQuizRedirect() {
			const dueItems = getDueItems();
			const quizSection = document.getElementById('quizRedirect');
			quizSection.style.display = dueItems.length > 0 ? 'block' : 'none';
		}

		// Add vocabulary
		async function addVocab(word, def) {
			if (!word.trim() || !def.trim()) {
				alert('Please enter both word and definition');
				return;
			}

			const newItem = {
				id: Date.now(),
				word: word.trim(),
				def: def.trim(),
				dateAdded: todayStr(),
				reviews: [],
				processed: false
			};

			state.items.push(newItem);
			await apiPutState(state);
			renderAll();
			initPool();
		}

		// Delete vocabulary
		async function deleteVocab(id) {
			if (!confirm('Are you sure you want to delete this vocabulary?')) return;

			state.items = state.items.filter(it => it.id !== id);
			await apiPutState(state);
			renderAll();
			checkQuizRedirect();
			initPool();
		}

		// Edit vocabulary - open modal
		function editVocab(id) {
			const item = state.items.find(it => it.id === id);
			if (!item) return;

			editingId = id;
			document.getElementById('editWord').value = item.word;
			document.getElementById('editDef').value = item.def;
			document.getElementById('editModal').classList.add('show');
		}

		// Close edit modal
		function closeEditModal() {
			document.getElementById('editModal').classList.remove('show');
			editingId = null;
		}

		// Save edited vocabulary
		async function saveEdit() {
			const item = state.items.find(it => it.id === editingId);
			if (!item) return;

			const newWord = document.getElementById('editWord').value.trim();
			const newDef = document.getElementById('editDef').value.trim();

			if (!newWord || !newDef) {
				alert('Word and definition cannot be empty');
				return;
			}

			item.word = newWord;
			item.def = newDef;
			await apiPutState(state);
			closeEditModal();
			renderAll();
			initPool();
		}

		// Search filter function
		function filterItems(items) {
			if (!searchQuery.trim()) return items;
			const query = searchQuery.toLowerCase();
			return items.filter(item =>
				item.word.toLowerCase().includes(query) ||
				item.def.toLowerCase().includes(query)
			);
		}

		// Render all tables
		function renderAll() {
			// Update pool message
			const totalVocabs = state.items.length;
			document.getElementById('poolMessage').textContent = `You have stored ${totalVocabs} vocab${totalVocabs !== 1 ? 's' : ''}! Keep going! üéâ`;

			// Render all vocabulary table (with search filter)
			const allTbody = document.querySelector('#allList tbody');
			allTbody.innerHTML = '';
			const filteredItems = filterItems(state.items.slice().reverse());
			filteredItems.forEach(item => {
				const tr = document.createElement('tr');
				tr.innerHTML = `
					<td>${escapeHtml(item.word)}</td>
					<td>${escapeHtml(item.def)}</td>
					<td>${item.dateAdded}</td>
					<td>${(item.reviews || []).join(', ') || '-'}</td>
					<td>
						<button class="btn-edit" onclick="editVocab(${item.id})">‚úèÔ∏è Edit</button>
						<button class="btn-danger" onclick="deleteVocab(${item.id})">üóëÔ∏è Delete</button>
					</td>
				`;
				allTbody.appendChild(tr);
			});

			// Render today's vocabulary table
			const todayTbody = document.querySelector('#todayList tbody');
			todayTbody.innerHTML = '';
			const today = todayStr();
			const todayItems = state.items.filter(it => it.dateAdded === today);

			todayItems.forEach(item => {
				const tr = document.createElement('tr');
				const reviewCount = (item.reviews || []).length;
				const status = reviewCount >= 4 ? '‚úÖ Completed' : `üìù ${reviewCount}/4 Reviews`;
				tr.innerHTML = `
					<td>${escapeHtml(item.word)}</td>
					<td>${escapeHtml(item.def)}</td>
					<td>${status}</td>
					<td>
						<button class="btn-edit" onclick="editVocab(${item.id})">‚úèÔ∏è Edit</button>
						<button class="btn-danger" onclick="deleteVocab(${item.id})">üóëÔ∏è Delete</button>
					</td>
				`;
				todayTbody.appendChild(tr);
			});
		}

		// Floating pool animation
		let poolCards = [];
		let animationFrame = null;

		function initPool() {
			const pool = document.getElementById('vocabPool');
			pool.innerHTML = '';
			poolCards = [];

			if (animationFrame) cancelAnimationFrame(animationFrame);

			const poolRect = pool.getBoundingClientRect();
			const maxCards = Math.min(state.items.length, 30); // Limit to 30 cards for performance

			state.items.slice(0, maxCards).forEach((item, index) => {
				const card = document.createElement('div');
				card.className = 'vocab-card';
				card.textContent = item.word;
				card.title = item.def; // Show definition on hover

				const size = { width: 120, height: 36 };
				const position = {
					x: Math.random() * (poolRect.width - size.width),
					y: Math.random() * (poolRect.height - size.height)
				};
				const velocity = {
					x: (Math.random() - 0.5) * 2,
					y: (Math.random() - 0.5) * 2
				};

				card.style.left = position.x + 'px';
				card.style.top = position.y + 'px';
				pool.appendChild(card);

				poolCards.push({ card, position, velocity, size });
			});

			animatePool();
		}

		function animatePool() {
			const pool = document.getElementById('vocabPool');
			if (!pool) return;

			const poolRect = pool.getBoundingClientRect();
			const poolWidth = poolRect.width;
			const poolHeight = poolRect.height;

			poolCards.forEach((cardData) => {
				const { card, position, velocity, size } = cardData;

				// Update position
				position.x += velocity.x;
				position.y += velocity.y;

				// Bounce off walls
				if (position.x <= 0 || position.x + size.width >= poolWidth) {
					velocity.x *= -1;
					position.x = Math.max(0, Math.min(position.x, poolWidth - size.width));
				}
				if (position.y <= 0 || position.y + size.height >= poolHeight) {
					velocity.y *= -1;
					position.y = Math.max(0, Math.min(position.y, poolHeight - size.height));
				}

				// Apply friction (water resistance)
				velocity.x *= 0.99;
				velocity.y *= 0.99;

				// Add slight random movement (water currents)
				velocity.x += (Math.random() - 0.5) * 0.1;
				velocity.y += (Math.random() - 0.5) * 0.1;

				// Limit max speed
				const maxSpeed = 3;
				const speed = Math.sqrt(velocity.x ** 2 + velocity.y ** 2);
				if (speed > maxSpeed) {
					velocity.x = (velocity.x / speed) * maxSpeed;
					velocity.y = (velocity.y / speed) * maxSpeed;
				}

				// Update card position
				card.style.left = position.x + 'px';
				card.style.top = position.y + 'px';
			});

			animationFrame = requestAnimationFrame(animatePool);
		}

		// Create floating elements
		function createFloatingElements() {
			const container = document.querySelector('.floating-elements');
			const symbols = ['üìö', '‚ú®', 'üåü', 'üìñ', 'üí°', 'üéØ'];

			for (let i = 0; i < 15; i++) {
				const elem = document.createElement('div');
				elem.classList.add('floating-element');
				elem.textContent = symbols[Math.floor(Math.random() * symbols.length)];
				elem.style.left = Math.random() * 100 + '%';
				elem.style.top = Math.random() * 100 + '%';
				elem.style.animationDelay = Math.random() * 6 + 's';
				elem.style.animationDuration = (Math.random() * 4 + 4) + 's';
				container.appendChild(elem);
			}
		}

		// Event listeners
		document.getElementById('addBtn').addEventListener('click', async () => {
			const word = document.getElementById('inputWord').value;
			const def = document.getElementById('inputDef').value;
			await addVocab(word, def);
			document.getElementById('inputWord').value = '';
			document.getElementById('inputDef').value = '';
			checkQuizRedirect();
		});

		document.getElementById('clearBtn').addEventListener('click', () => {
			document.getElementById('inputWord').value = '';
			document.getElementById('inputDef').value = '';
		});

		document.getElementById('saveEditBtn').addEventListener('click', saveEdit);
		document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);

		// Keyboard shortcuts
		document.getElementById('inputWord').addEventListener('keypress', (e) => {
			if (e.key === 'Enter') document.getElementById('inputDef').focus();
		});

		document.getElementById('inputDef').addEventListener('keypress', (e) => {
			if (e.key === 'Enter' && e.ctrlKey) document.getElementById('addBtn').click();
		});

		// Close modal on background click
		document.getElementById('editModal').addEventListener('click', (e) => {
			if (e.target === e.currentTarget) closeEditModal();
		});

		// Search functionality
		document.getElementById('searchInput').addEventListener('input', (e) => {
			searchQuery = e.target.value;
			renderAll();
		});

		// Initialize
		(async function init() {
			try {
				state = await apiGetState();

				// Ensure items array exists
				if (!state.items) state.items = [];

				renderAll();
				checkQuizRedirect();
				createFloatingElements();
				initPool();
			} catch (error) {
				console.error('Failed to initialize:', error);
			}
		})();

		// Make functions globally accessible
		window.editVocab = editVocab;
		window.deleteVocab = deleteVocab;
	</script>
</body>
</html>
